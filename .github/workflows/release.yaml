name: Release

on:
  workflow_call:
    inputs:
      version:
        description: 'Version to release'
        required: true
        type: string
    secrets:
      KEYSTORE_BASE64:
        description: 'Base64 encoded keystore file'
        required: true
      STORE_PASSWORD:
        description: 'Password for the keystore'
        required: true

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: ğŸ“š Git Checkout
        uses: actions/checkout@v6
      
      - name: Set up java SDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          check-latest: true

      - name: ğŸ” Setup Keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > android/app/key.jks
          echo "storePassword=${{ secrets.STORE_PASSWORD }}" > android/key.properties
          echo "keyPassword=${{ secrets.STORE_PASSWORD }}" >> android/key.properties
          echo "keyAlias=upload" >> android/key.properties
          echo "storeFile=key.jks" >> android/key.properties

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true
          cache-key: flutter-:os:-:channel:-:version:-:arch:-:hash:-${{ hashFiles('**/pubspec.lock') }}

      - name: ğŸ“¦ Install Dependencies
        run: |
          dart pub global activate melos
          echo "$HOME/.pub-cache/bin" >> $GITHUB_PATH
          echo "$HOME/AppData/Local/Pub/Cache/bin" >> $GITHUB_PATH
          melos bootstrap

      - name: âœ¨ Generate code
        run: melos run generate

      - name: ğŸ—ï¸ Build production APK
        run: melos run release-prod

      - name: ğŸ“± Upload APK Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-apks
          path: build/app/outputs/flutter-apk/*.apk

      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: build/app/outputs/flutter-apk/*.apk
          generate_release_notes: true
          tag_name: v${{ inputs.version }}
          name: Release ${{ inputs.version }}
